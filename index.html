<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SVE Parts Request</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&display=swap');

  :root {
    --yellow: #F5C100;
    --black: #0D0D0D;
    --dark: #1A1A1A;
    --mid: #2C2C2C;
    --border: #3A3A3A;
    --text: #E8E8E8;
    --muted: #888;
    --green: #22C55E;
    --blue: #3B82F6;
    --orange: #F97316;
    --red: #EF4444;
    --purple: #d946ef;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--black); color: var(--text); font-family: 'Barlow', sans-serif; font-size: 16px; min-height: 100vh; }

  .header { background: var(--yellow); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .header-title { font-family: 'Barlow Condensed', sans-serif; font-size: 22px; font-weight: 800; color: var(--black); letter-spacing: 1px; text-transform: uppercase; }
  .header-sub { font-size: 11px; font-weight: 600; color: #555; letter-spacing: 2px; text-transform: uppercase; }
  .notif-btn { background: var(--black); border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; }

  .parts-in-banner { background: var(--green); color: var(--black); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 10px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 15px; letter-spacing: 1px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.85} }
  .parts-in-banner button { background: rgba(0,0,0,0.2); border: none; color: var(--black); font-weight: 700; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; white-space: nowrap; }

  .role-bar { display: flex; background: var(--dark); border-bottom: 2px solid var(--border); }
  .role-btn { flex: 1; padding: 12px 8px; border: none; background: transparent; color: var(--muted); font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.15s; }
  .role-btn.active { color: var(--yellow); border-bottom-color: var(--yellow); }

  .main { padding: 16px; max-width: 700px; margin: 0 auto; padding-bottom: 90px; }

  .section-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--muted); margin: 20px 0 8px; }
  .section-label:first-child { margin-top: 0; }

  .card { background: var(--dark); border: 1px solid var(--border); border-radius: 6px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: border-color 0.15s; }
  .card:hover { border-color: var(--yellow); }
  .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
  .card-title { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 700; }
  .card-meta { font-size: 13px; color: var(--muted); margin-top: 3px; }

  .badge { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; padding: 3px 8px; border-radius: 3px; white-space: nowrap; }
  .badge-draft         { background: var(--mid); color: var(--muted); }
  .badge-pending       { background: #1e3a5f; color: var(--blue); }
  .badge-needsquote    { background: #3b1f00; color: var(--orange); }
  .badge-approved      { background: #052e16; color: var(--green); }
  .badge-reviewquote   { background: #3b1f00; color: var(--orange); }
  .badge-quoteapproved { background: #052e16; color: var(--green); }
  .badge-partsorderd   { background: #1e3a5f; color: var(--blue); }
  .badge-partsinshop   { background: #052e16; color: var(--green); }
  .badge-callcustomer  { background: #3b0764; color: var(--purple); }
  .badge-quoted        { background: #1e3a5f; color: var(--blue); }

  .form-group { margin-bottom: 14px; }
  label { display: block; font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
  input, select, textarea { width: 100%; background: var(--mid); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: 'Barlow', sans-serif; font-size: 16px; padding: 11px 12px; outline: none; transition: border-color 0.15s; -webkit-appearance: none; }
  input:focus, select:focus, textarea:focus { border-color: var(--yellow); }
  textarea { resize: vertical; min-height: 80px; }

  .parts-list { display: flex; flex-direction: column; gap: 10px; }
  .part-row { background: var(--mid); border: 1px solid var(--border); border-radius: 5px; padding: 12px; position: relative; }
  .part-row-grid { display: grid; grid-template-columns: 1fr 70px; gap: 8px; margin-bottom: 8px; }
  .part-row-grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
  .part-label { font-size: 11px; color: var(--muted); font-weight: 600; letter-spacing: 1px; margin-bottom: 4px; }
  .part-input { background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 15px; padding: 8px 10px; width: 100%; outline: none; font-family: 'Barlow', sans-serif; }
  .part-input:focus { border-color: var(--yellow); }
  .remove-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--red); font-size: 18px; cursor: pointer; line-height: 1; padding: 2px 6px; }

  .quote-item { background: var(--mid); border: 1px solid var(--border); border-radius: 5px; padding: 12px; margin-bottom: 8px; }
  .quote-item-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
  .quote-item-meta { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
  .approve-decline-row { display: flex; gap: 8px; }
  .appr-btn { flex: 1; padding: 9px; border: 2px solid var(--border); border-radius: 4px; background: transparent; color: var(--muted); font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 1px; cursor: pointer; text-transform: uppercase; transition: all 0.15s; }
  .appr-btn.sel-approve { border-color: var(--green); background: #052e16; color: var(--green); }
  .appr-btn.sel-decline { border-color: var(--red); background: #3b0000; color: var(--red); }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 13px 20px; border: none; border-radius: 5px; font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
  .btn:active { transform: scale(0.97); }
  .btn-yellow { background: var(--yellow); color: var(--black); width: 100%; }
  .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); width: 100%; }
  .btn-green  { background: var(--green); color: var(--black); width: 100%; }
  .btn-orange { background: var(--orange); color: var(--black); width: 100%; }
  .btn-blue   { background: var(--blue); color: white; width: 100%; }
  .btn-sm     { padding: 8px 14px; font-size: 13px; width: auto; }
  .btn-row    { display: flex; gap: 10px; margin-top: 6px; }
  .btn-row .btn { flex: 1; }

  .photo-upload-area { border: 2px dashed var(--border); border-radius: 6px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.15s; }
  .photo-upload-area:hover { border-color: var(--yellow); }
  .photo-upload-area input { display: none; }
  .photo-icon { font-size: 30px; margin-bottom: 6px; }
  .photo-upload-text { font-size: 14px; color: var(--muted); }
  .photo-previews { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .photo-preview { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border); }

  .info-block { background: var(--mid); border-radius: 5px; padding: 12px 14px; margin-bottom: 10px; }
  .info-row { display: flex; justify-content: space-between; font-size: 14px; padding: 5px 0; border-bottom: 1px solid var(--border); }
  .info-row:last-child { border-bottom: none; }
  .info-key { color: var(--muted); font-weight: 500; }
  .info-val { font-weight: 600; text-align: right; max-width: 65%; }

  .parts-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .parts-table th { text-align: left; padding: 7px 8px; color: var(--muted); font-size: 10px; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  .parts-table td { padding: 8px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
  .parts-table tr:last-child td { border-bottom: none; }
  .td-declined { color: var(--red); text-decoration: line-through; opacity: 0.6; }

  .divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }

  .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--green); color: var(--black); font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: 1px; padding: 12px 24px; border-radius: 6px; z-index: 999; transition: transform 0.3s; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 200; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .overlay.open { display: block; }
  .modal { background: var(--dark); border: 1px solid var(--border); border-radius: 8px; margin: 16px auto; max-width: 660px; }
  .modal-header { background: var(--mid); padding: 14px 16px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); gap: 10px; }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 17px; font-weight: 800; }
  .close-btn { background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer; line-height: 1; flex-shrink: 0; }
  .modal-body { padding: 16px; }

  .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-icon { font-size: 40px; margin-bottom: 10px; }

  .fab { position: fixed; bottom: 20px; right: 16px; background: var(--yellow); color: var(--black); border: none; border-radius: 50px; padding: 14px 20px; font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; box-shadow: 0 4px 20px rgba(245,193,0,0.4); z-index: 50; display: flex; align-items: center; gap: 6px; }

  .notif-prompt { background: #1e3a5f; border: 1px solid var(--blue); border-radius: 6px; padding: 14px; margin-bottom: 16px; }
  .notif-prompt-title { font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 16px; color: var(--blue); margin-bottom: 5px; }
  .notif-prompt-text { font-size: 13px; color: #93c5fd; }

  .dec-tag { font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 3px; }
  .dec-tag-approve { background: #052e16; color: var(--green); }
  .dec-tag-decline { background: #3b0000; color: var(--red); }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="header-title">SVE Parts Request</div>
    <div class="header-sub">South Valley Equipment</div>
  </div>
  <button class="notif-btn" onclick="setupNotifications()" title="Enable Notifications">üîî</button>
</div>

<div id="bannerArea"></div>

<div class="role-bar">
  <button class="role-btn active" onclick="switchRole('tech')">üîß Tech</button>
  <button class="role-btn" onclick="switchRole('manager')">üìã Manager</button>
  <button class="role-btn" onclick="switchRole('parts')">üì¶ Parts</button>
</div>

<div class="main" id="mainContent"></div>

<button class="fab" id="fabBtn" onclick="openNewForm()">+ New Request</button>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Request</div>
      <button class="close-btn" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// Globals needed by dynamic HTML onclick handlers
let tempParts = [];
let tempPhotos = [];
let tempItems = [];
let decisions = {};

(async function() {
// ==================== CONFIG ====================
const PUSH_SERVER = 'https://sve-push-server.onrender.com';
const VAPID_KEY   = 'BErS69dImlqYjcvuJ2IVli4QDMIzzj7pSP99ICXV9OXkIz8hKiumFxNRIRNvW9dz4FIeMb3eybGHQdJg8cvmuJc';

// ==================== STORE ====================
let currentRole = 'tech';
let currentId   = null;
let _cache      = [];  // local cache of requests

// ---- API helpers ----
async function apiGet(path) {
  const r = await fetchWithRetry(PUSH_SERVER + path, { method: 'GET' });
  return r.json();
}
async function apiPost(path, body) {
  const r = await fetchWithRetry(PUSH_SERVER + path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  return r.json();
}
async function apiPut(path, body) {
  const r = await fetchWithRetry(PUSH_SERVER + path, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  return r.json();
}
async function apiDelete(path) {
  const r = await fetchWithRetry(PUSH_SERVER + path, { method: 'DELETE' });
  return r.json();
}

async function loadAll() {
  _cache = await apiGet('/requests');
  return _cache;
}
function byId(id) { return _cache.find(r => r.id === id); }
async function update(id, u) {
  Object.assign(_cache.find(r => r.id === id) || {}, u);
  await apiPut('/requests/' + id, u);
}

// ==================== STATUS ====================
const S = {
  draft:         { label: 'Draft',           cls: 'badge-draft' },
  pending:       { label: 'Pending Review',  cls: 'badge-pending' },
  needsquote:    { label: 'Needs Quote',     cls: 'badge-needsquote' },
  approved:      { label: 'Approved',        cls: 'badge-approved' },
  reviewquote:   { label: 'Review Quote',    cls: 'badge-reviewquote' },
  quoteapproved: { label: 'Quote Approved',  cls: 'badge-quoteapproved' },
  partsorderd:   { label: 'Parts Ordered',   cls: 'badge-partsorderd' },
  partsinshop:   { label: 'Parts In Shop',   cls: 'badge-partsinshop' },
  callcustomer:  { label: 'Call Customer',   cls: 'badge-callcustomer' },
  quoted:        { label: 'Quoted',          cls: 'badge-quoted' },
};

function badge(status) {
  const s = S[status] || S.draft;
  return '<span class="badge ' + s.cls + '">' + s.label + '</span>';
}

// ==================== PUSH ====================
function b64ToUint8(b64) {
  const pad = '='.repeat((4 - b64.length % 4) % 4);
  const raw = atob((b64 + pad).replace(/-/g,'+').replace(/_/g,'/'));
  return Uint8Array.from(raw, c => c.charCodeAt(0));
}

async function setupNotifications() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    alert('Push not supported in this browser.\niPhone: use Safari + Add to Home Screen\nAndroid: use Chrome'); return;
  }
  const perm = await Notification.requestPermission();
  if (perm !== 'granted') { showToast('Notifications blocked ‚Äî check browser settings'); return; }

  try {
    // Use real sw.js file ‚Äî required for iOS Safari
    const swUrl = location.origin + location.pathname.replace('index.html','') + 'sw.js';
    let reg = await navigator.serviceWorker.getRegistration(swUrl);
    if (!reg) reg = await navigator.serviceWorker.register(swUrl);
    await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: b64ToUint8(VAPID_KEY) });
    await fetchWithRetry(PUSH_SERVER + '/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
    showToast('üîî Notifications ON!');
  } catch(e) { console.error(e); showToast('Notification setup failed: ' + e.message); }
}

async function fetchWithRetry(url, options, retries=2, delay=8000) {
  for (let i = 0; i <= retries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) return res;
    } catch(e) {
      if (i < retries) { await new Promise(r => setTimeout(r, delay)); }
      else throw e;
    }
  }
}

async function pushNotify(title, body) {
  try {
    await fetchWithRetry(PUSH_SERVER + '/notify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, body }) });
  } catch(e) { console.error('Push failed', e); }
}

// ==================== BANNERS ====================
async function addBanner(id, machine, wo) {
  await apiPost('/banners', { bid: 'b' + Date.now(), id, machine, wo });
  await renderBanners();
}
async function dismissBanner(bid) {
  await apiDelete('/banners/' + bid);
  await renderBanners();
}
async function renderBanners() {
  try {
    const el = document.getElementById('bannerArea');
    const b = await apiGet('/banners');
    el.innerHTML = b.map(x =>
      '<div class="parts-in-banner">üü¢ PARTS IN ‚Äî ' + esc(x.machine) + ' &nbsp; WO#' + esc(x.wo) +
      '<button onclick="dismissBanner(\'' + x.bid + '\')">Got it ‚úì</button></div>'
    ).join('');
  } catch(e) { console.error('Banner error', e); }
}

// ==================== ROLE ====================
function switchRole(role) {
  currentRole = role;
  document.querySelectorAll('.role-btn').forEach((b,i) => b.classList.toggle('active', ['tech','manager','parts'][i] === role));
  document.getElementById('fabBtn').style.display = role === 'tech' ? 'flex' : 'none';
  renderMain();
}

// ==================== MAIN LIST ====================
async function renderMain() {
  const el = document.getElementById('mainContent');
  el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div><div>Loading...</div></div>';
  try {
    const reqs = await loadAll();
    el.innerHTML = '';
    if (currentRole === 'tech')         renderTech(el, reqs);
    else if (currentRole === 'manager') renderManager(el, reqs);
    else                                renderParts(el, reqs);
  } catch(e) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div>Could not load requests.<br>Check your connection.</div></div>';
  }
}

function renderTech(el, reqs) {
  if ('Notification' in window && Notification.permission === 'default') {
    el.innerHTML += '<div class="notif-prompt"><div class="notif-prompt-title">üîî Get notified when parts arrive</div><div class="notif-prompt-text">Tap the bell icon (top right) to enable phone notifications.</div></div>';
  }
  const drafts = reqs.filter(r => r.status === 'draft');
  const sub    = reqs.filter(r => r.status !== 'draft');
  if (drafts.length) { el.innerHTML += '<div class="section-label">My Drafts</div>'; drafts.forEach(r => el.innerHTML += cardHtml(r)); }
  if (sub.length)    { el.innerHTML += '<div class="section-label">Submitted</div>'; sub.forEach(r => el.innerHTML += cardHtml(r)); }
  if (!reqs.length)  el.innerHTML += '<div class="empty"><div class="empty-icon">üîß</div><div>No requests yet. Tap + New Request.</div></div>';
}

function renderManager(el, reqs) {
  const sections = [
    { label: '‚ö° Needs Your Review',   filter: r => r.status === 'pending' },
    { label: 'üìù Quote Ready ‚Äî Review', filter: r => r.status === 'reviewquote' },
    { label: 'üìû Call Customer',        filter: r => r.status === 'callcustomer' },
    { label: 'In Progress',             filter: r => ['needsquote','approved','quoteapproved','partsorderd'].includes(r.status) },
    { label: 'Complete',                filter: r => ['partsinshop','quoted'].includes(r.status) },
  ];
  let any = false;
  sections.forEach(s => {
    const items = reqs.filter(s.filter);
    if (items.length) { any = true; el.innerHTML += '<div class="section-label">' + s.label + '</div>'; items.forEach(r => el.innerHTML += cardHtml(r)); }
  });
  if (!any) el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><div>No requests yet.</div></div>';
}

function renderParts(el, reqs) {
  const sections = [
    { label: '‚ö° Action Needed',       filter: r => ['needsquote','approved','quoteapproved'].includes(r.status) },
    { label: '‚è≥ Waiting on Delivery', filter: r => r.status === 'partsorderd' },
    { label: 'Complete',               filter: r => ['partsinshop','quoted','callcustomer'].includes(r.status) },
  ];
  let any = false;
  sections.forEach(s => {
    const items = reqs.filter(s.filter);
    if (items.length) { any = true; el.innerHTML += '<div class="section-label">' + s.label + '</div>'; items.forEach(r => el.innerHTML += cardHtml(r)); }
  });
  if (!any) el.innerHTML = '<div class="empty"><div class="empty-icon">üì¶</div><div>Nothing to action right now.</div></div>';
}

function cardHtml(r) {
  return '<div class="card" onclick="openRequest(\'' + r.id + '\')">' +
    '<div class="card-header"><div>' +
    '<div class="card-title">' + esc(r.machine || 'Unnamed Machine') + '</div>' +
    '<div class="card-meta">WO# ' + esc(r.workorder || '‚Äî') + ' &nbsp;¬∑&nbsp; ' + esc(r.tech || '‚Äî') + ' &nbsp;¬∑&nbsp; ' + ago(r.updatedAt) + '</div>' +
    '</div>' + badge(r.status) + '</div></div>';
}

// ==================== OPEN / CLOSE MODAL ====================
async function openNewForm() {
  const id = 'req_' + Date.now();
  const doc = { id, status:'draft', tech:'', machine:'', make:'', model:'', serial:'', workorder:'', notes:'', parts:[], photos:[], managerNotes:'', partsNotes:'', partsItems:[], quoteDecisions:{}, createdAt:Date.now(), updatedAt:Date.now() };
  await apiPost('/requests', doc);
  _cache.unshift(doc);
  openRequest(id);
}

window.openRequest = function(id) {
  currentId = id;
  const r = byId(id);
  if (!r) return;
  tempParts  = r.parts      ? JSON.parse(JSON.stringify(r.parts))      : [];
  tempPhotos = r.photos     ? [...r.photos]                             : [];
  tempItems  = r.partsItems ? JSON.parse(JSON.stringify(r.partsItems)) : [];
  decisions  = r.quoteDecisions ? { ...r.quoteDecisions }              : {};
  document.getElementById('overlay').classList.add('open');
  renderModal(r);
};

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  renderMain();
  renderBanners();
}

function renderModal(r) {
  document.getElementById('modalTitle').innerHTML = esc(r.machine || 'New Request') + ' &nbsp; ' + badge(r.status);
  const body = document.getElementById('modalBody');
  if (currentRole === 'tech')         body.innerHTML = r.status === 'draft' ? techForm(r) : techReadOnly(r);
  else if (currentRole === 'manager') body.innerHTML = managerView(r);
  else                                body.innerHTML = partsView(r);
}

// ==================== TECH FORM ====================
function techForm(r) {
  return '<div class="section-label">Machine Info</div>' +
    '<div class="form-group"><label>Tech Name</label><input id="f_tech" value="' + esc(r.tech) + '" placeholder="Your name"></div>' +
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">' +
    '<div class="form-group"><label>Make</label><input id="f_make" value="' + esc(r.make) + '" placeholder="e.g. Bobcat"></div>' +
    '<div class="form-group"><label>Model</label><input id="f_model" value="' + esc(r.model) + '" placeholder="e.g. S770"></div></div>' +
    '<div class="form-group"><label>Serial Number</label><input id="f_serial" value="' + esc(r.serial) + '" placeholder="Machine serial #"></div>' +
    '<div class="form-group"><label>Work Order #</label><input id="f_workorder" value="' + esc(r.workorder) + '" placeholder="WO number"></div>' +
    '<hr class="divider"><div class="section-label">Parts Requested</div>' +
    '<div class="parts-list" id="partsListEdit">' + partRowsHtml() + '</div>' +
    '<button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="addPart()">+ Add Part</button>' +
    '<hr class="divider"><div class="section-label">Photos</div>' +
    '<div class="photo-upload-area" onclick="document.getElementById(\'photoIn\').click()">' +
    '<input type="file" id="photoIn" multiple accept="image/*" onchange="handlePhotos(event)">' +
    '<div class="photo-icon">üì∑</div><div class="photo-upload-text">Tap to add photos</div></div>' +
    '<div class="photo-previews" id="photoPrev">' + tempPhotos.map(p => '<img class="photo-preview" src="' + p + '">').join('') + '</div>' +
    '<hr class="divider"><div class="form-group"><label>Notes</label><textarea id="f_notes" placeholder="Describe the issue...">' + esc(r.notes) + '</textarea></div>' +
    '<div class="btn-row"><button class="btn btn-outline" onclick="saveDraft()">Save Draft</button>' +
    '<button class="btn btn-yellow" onclick="submitMgr()">Submit to Manager ‚Üí</button></div>';
}

function partRowsHtml() {
  if (!tempParts.length) return '<div style="color:var(--muted);font-size:14px;padding:6px 0;">No parts added yet.</div>';
  return tempParts.map((p,i) =>
    '<div class="part-row"><button class="remove-btn" onclick="removePart(' + i + ')">‚úï</button>' +
    '<div class="part-row-grid">' +
    '<div><div class="part-label">Description</div><input class="part-input" value="' + esc(p.desc) + '" onchange="tempParts[' + i + '].desc=this.value" placeholder="Part description"></div>' +
    '<div><div class="part-label">Qty</div><input class="part-input" type="number" min="1" value="' + (p.qty||1) + '" onchange="tempParts[' + i + '].qty=this.value" style="text-align:center;"></div></div>' +
    '<div><div class="part-label">Part # (optional)</div><input class="part-input" value="' + esc(p.partnum) + '" onchange="tempParts[' + i + '].partnum=this.value" placeholder="If known"></div>' +
    '</div>'
  ).join('');
}

function addPart() { tempParts.push({desc:'',qty:1,partnum:''}); document.getElementById('partsListEdit').innerHTML = partRowsHtml(); }
function removePart(i) { tempParts.splice(i,1); document.getElementById('partsListEdit').innerHTML = partRowsHtml(); }

function handlePhotos(e) {
  Array.from(e.target.files).forEach(f => {
    const rd = new FileReader();
    rd.onload = ev => { tempPhotos.push(ev.target.result); document.getElementById('photoPrev').innerHTML = tempPhotos.map(p => '<img class="photo-preview" src="' + p + '">').join(''); };
    rd.readAsDataURL(f);
  });
}

function gatherTech() {
  const make = document.getElementById('f_make')?.value || '';
  const model = document.getElementById('f_model')?.value || '';
  return { tech: document.getElementById('f_tech')?.value||'', make, model, serial: document.getElementById('f_serial')?.value||'', workorder: document.getElementById('f_workorder')?.value||'', notes: document.getElementById('f_notes')?.value||'', machine: [make,model].filter(Boolean).join(' ')||'Unknown Machine', parts:[...tempParts], photos:[...tempPhotos], updatedAt:Date.now() };
}

async function saveDraft() { await update(currentId, {...gatherTech(), status:'draft'}); showToast('Draft saved'); renderModal(byId(currentId)); }

function submitMgr() {
  const f = gatherTech();
  if (!f.tech) { alert('Enter your name.'); return; }
  if (!f.workorder) { alert('Enter a Work Order #.'); return; }
  await update(currentId, {...f, status:'pending'});
  showToast('Submitted to Manager!');
  closeModal();
}

function techReadOnly(r) {
  let h = infoBlock(r) + partsRO(r.parts);
  if (r.photos?.length) h += '<div class="photo-previews" style="margin-top:10px;">' + r.photos.map(p=>'<img class="photo-preview" src="'+p+'">').join('') + '</div>';
  if (r.partsItems?.length) h += '<hr class="divider"><div class="section-label">Parts Details</div>' + itemsRO(r.partsItems, r.quoteDecisions);
  if (r.managerNotes) h += '<hr class="divider"><div class="section-label">Manager Notes</div><div class="info-block">' + esc(r.managerNotes) + '</div>';
  if (r.status === 'partsinshop') h += '<div style="background:#052e16;border:1px solid var(--green);border-radius:6px;padding:14px;margin-top:10px;font-family:Barlow Condensed,sans-serif;font-weight:700;color:var(--green);font-size:18px;text-align:center;">üü¢ YOUR PARTS ARE IN THE SHOP</div>';
  return h;
}

// ==================== MANAGER VIEW ====================
function managerView(r) {
  let h = infoBlock(r) + partsRO(r.parts);
  if (r.photos?.length) h += '<div class="photo-previews" style="margin-top:10px;">' + r.photos.map(p=>'<img class="photo-preview" src="'+p+'">').join('') + '</div>';

  if (r.status === 'pending') {
    h += '<hr class="divider"><div class="section-label">Your Decision</div>' +
      '<div class="form-group"><label>Notes (optional)</label><textarea id="m_notes" placeholder="Notes for parts...">' + esc(r.managerNotes) + '</textarea></div>' +
      '<div class="btn-row"><button class="btn btn-orange" onclick="mgrDecide(\'needsquote\')">üìù Needs Quote</button>' +
      '<button class="btn btn-green" onclick="mgrDecide(\'approved\')">‚úÖ Approve Order</button></div>';

  } else if (r.status === 'reviewquote') {
    h += '<hr class="divider"><div class="section-label">Quote from Parts ‚Äî Approve or Decline Each Part</div>' +
      quoteReviewHtml(r) +
      '<div class="form-group" style="margin-top:14px;"><label>Notes (optional)</label><textarea id="m_notes" placeholder="Notes for parts...">' + esc(r.managerNotes) + '</textarea></div>' +
      '<div class="btn-row"><button class="btn btn-yellow" onclick="submitDecisions()">Submit Decisions ‚Üí</button></div>';

  } else if (r.status === 'callcustomer') {
    h += '<hr class="divider"><div class="section-label">Quote Details</div>' + itemsRO(r.partsItems, r.quoteDecisions);
    if (r.partsNotes) h += '<div class="info-block" style="margin-top:8px;">' + esc(r.partsNotes) + '</div>';
    h += '<div class="btn-row" style="margin-top:14px;"><button class="btn btn-green" onclick="mgrDone()">‚úÖ Customer Called / Done</button></div>';

  } else {
    if (r.partsItems?.length) h += '<hr class="divider"><div class="section-label">Parts Details</div>' + itemsRO(r.partsItems, r.quoteDecisions);
    if (r.managerNotes) h += '<hr class="divider"><div class="section-label">Your Notes</div><div class="info-block">' + esc(r.managerNotes) + '</div>';
  }
  return h;
}

function quoteReviewHtml(r) {
  if (!r.partsItems?.length) return '<div style="color:var(--muted);margin-bottom:10px;">No parts in quote.</div>';
  return r.partsItems.map((p,i) => {
    const dec = decisions[i] || '';
    return '<div class="quote-item">' +
      '<div class="quote-item-name">' + esc(p.desc||'‚Äî') + '</div>' +
      '<div class="quote-item-meta">Qty: ' + (p.qty||1) + ' &nbsp;¬∑&nbsp; Part#: ' + esc(p.partnum||'‚Äî') + ' &nbsp;¬∑&nbsp; Price: ' + esc(p.price||'‚Äî') + ' &nbsp;¬∑&nbsp; Vendor: ' + esc(p.vendor||'‚Äî') + ' &nbsp;¬∑&nbsp; Lead: ' + esc(p.leadtime||'‚Äî') + '</div>' +
      '<div class="approve-decline-row">' +
      '<button id="abtn_' + i + '" class="appr-btn' + (dec==='approve'?' sel-approve':'') + '" onclick="setDec(' + i + ',\'approve\')">‚úÖ Approve</button>' +
      '<button id="dbtn_' + i + '" class="appr-btn' + (dec==='decline'?' sel-decline':'') + '" onclick="setDec(' + i + ',\'decline\')">‚úï Decline</button>' +
      '</div></div>';
  }).join('');
}

function setDec(i, val) {
  decisions[i] = val;
  const ab = document.getElementById('abtn_' + i);
  const db = document.getElementById('dbtn_' + i);
  if (ab) ab.className = 'appr-btn' + (val==='approve' ? ' sel-approve' : '');
  if (db) db.className = 'appr-btn' + (val==='decline' ? ' sel-decline' : '');
}

function submitDecisions() {
  const notes = document.getElementById('m_notes')?.value || '';
  const anyApproved = Object.values(decisions).some(v => v === 'approve');
  await update(currentId, { quoteDecisions:{...decisions}, managerNotes:notes, status: anyApproved ? 'quoteapproved' : 'quoted', updatedAt:Date.now() });
  showToast(anyApproved ? 'Sent back to Parts!' : 'All parts declined ‚Äî ticket closed');
  closeModal();
}

async function mgrDecide(status) {
  const notes = document.getElementById('m_notes')?.value || '';
  await update(currentId, { status, managerNotes:notes, updatedAt:Date.now() });
  showToast(status === 'needsquote' ? 'Sent to Parts for Quote' : 'Approved ‚Äî Parts notified');
  closeModal();
}

async function mgrDone() {
  await update(currentId, { status:'quoted', updatedAt:Date.now() });
  showToast('Marked complete!');
  closeModal();
}

// ==================== PARTS VIEW ====================
function partsView(r) {
  let h = infoBlock(r) + partsRO(r.parts);
  if (r.photos?.length) h += '<div class="photo-previews" style="margin-top:10px;">' + r.photos.map(p=>'<img class="photo-preview" src="'+p+'">').join('') + '</div>';

  const editable = ['needsquote','approved','quoteapproved'].includes(r.status);

  if (editable) {
    h += '<hr class="divider"><div class="section-label">Parts Details</div>' +
      '<div class="parts-list" id="itemsEdit">' + itemRowsHtml() + '</div>' +
      '<button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="addItem()">+ Add Line</button>' +
      '<div class="form-group" style="margin-top:14px;"><label>Notes for Manager</label><textarea id="pi_notes" placeholder="Any notes...">' + esc(r.partsNotes) + '</textarea></div>';

    // If quoteapproved ‚Äî show manager decisions so parts guy knows what to order
    if (r.status === 'quoteapproved' && r.quoteDecisions && Object.keys(r.quoteDecisions).length) {
      h += '<hr class="divider"><div class="section-label">Manager Decisions</div>';
      (r.partsItems||[]).forEach((p,i) => {
        const dec = r.quoteDecisions[i];
        if (dec) h += '<div style="display:flex;align-items:center;gap:8px;padding:5px 0;font-size:14px;">' +
          '<span class="dec-tag ' + (dec==='approve'?'dec-tag-approve':'dec-tag-decline') + '">' + (dec==='approve'?'‚úÖ ORDER':'‚úï SKIP') + '</span>' +
          esc(p.desc||'‚Äî') + '</div>';
      });
    }

    h += '<hr class="divider">';
    if (r.status === 'needsquote') {
      h += '<div class="btn-row"><button class="btn btn-orange" onclick="partsAction(\'reviewquote\')">üìù Send Quote to Manager</button></div>';
    } else if (r.status === 'approved') {
      h += '<div class="btn-row">' +
        '<button class="btn btn-green" onclick="partsAction(\'partsorderd\')">üì¶ Parts Ordered</button>' +
        '<button class="btn btn-orange" onclick="partsAction(\'callcustomer\')">üìû Send Quote to Mgr</button></div>';
    } else if (r.status === 'quoteapproved') {
      h += '<div class="btn-row"><button class="btn btn-green" onclick="partsAction(\'partsorderd\')">üì¶ Mark Parts Ordered</button></div>';
    }

  } else if (r.status === 'partsorderd') {
    if (r.partsItems?.length) h += '<hr class="divider"><div class="section-label">Parts Details</div>' + itemsRO(r.partsItems, r.quoteDecisions);
    h += '<hr class="divider"><div class="btn-row"><button class="btn btn-green" onclick="markInShop()">üü¢ Parts In Shop</button></div>';

  } else {
    if (r.partsItems?.length) h += '<hr class="divider"><div class="section-label">Parts Details</div>' + itemsRO(r.partsItems, r.quoteDecisions);
  }

  return h;
}

function itemRowsHtml() {
  if (!tempItems.length) return '<div style="color:var(--muted);font-size:14px;padding:6px 0;">No parts added yet.</div>';
  return tempItems.map((p,i) =>
    '<div class="part-row"><button class="remove-btn" onclick="removeItem(' + i + ')">‚úï</button>' +
    '<div class="part-row-grid">' +
    '<div><div class="part-label">Description</div><input class="part-input" value="' + esc(p.desc) + '" onchange="tempItems[' + i + '].desc=this.value;syncItems()" placeholder="Part description"></div>' +
    '<div><div class="part-label">Qty</div><input class="part-input" type="number" min="1" value="' + (p.qty||1) + '" onchange="tempItems[' + i + '].qty=this.value;syncItems()" style="text-align:center;"></div></div>' +
    '<div class="part-row-grid2">' +
    '<div><div class="part-label">Part #</div><input class="part-input" value="' + esc(p.partnum) + '" onchange="tempItems[' + i + '].partnum=this.value;syncItems()" placeholder="Part number"></div>' +
    '<div><div class="part-label">Price</div><input class="part-input" value="' + esc(p.price) + '" onchange="tempItems[' + i + '].price=this.value;syncItems()" placeholder="$0.00"></div></div>' +
    '<div class="part-row-grid2">' +
    '<div><div class="part-label">Vendor</div><input class="part-input" value="' + esc(p.vendor) + '" onchange="tempItems[' + i + '].vendor=this.value;syncItems()" placeholder="e.g. Bobcat, NAPA"></div>' +
    '<div><div class="part-label">Lead Time</div><input class="part-input" value="' + esc(p.leadtime) + '" onchange="tempItems[' + i + '].leadtime=this.value;syncItems()" placeholder="e.g. 2-3 days"></div></div>' +
    '</div>'
  ).join('');
}

function syncItems() { apiPut('/requests/' + currentId, { partsItems:[...tempItems] }); }

function addItem() {
  syncItems();
  tempItems.push({desc:'',qty:1,partnum:'',price:'',vendor:'',leadtime:''});
  apiPut('/requests/' + currentId, { partsItems:[...tempItems] });
  document.getElementById('itemsEdit').innerHTML = itemRowsHtml();
}

function removeItem(i) {
  syncItems();
  tempItems.splice(i,1);
  apiPut('/requests/' + currentId, { partsItems:[...tempItems] });
  document.getElementById('itemsEdit').innerHTML = itemRowsHtml();
}

async function partsAction(nextStatus) {
  syncItems();
  const notes = document.getElementById('pi_notes')?.value || '';
  await update(currentId, { status:nextStatus, partsNotes:notes, partsItems:[...tempItems], updatedAt:Date.now() });
  const msgs = { reviewquote:'Quote sent to Manager!', partsorderd:'Parts marked as ordered!', callcustomer:'Quote sent to Manager!' };
  showToast(msgs[nextStatus] || 'Done!');
  closeModal();
}

async function markInShop() {
  const r = byId(currentId);
  await update(currentId, { status:'partsinshop', updatedAt:Date.now() });
  await addBanner(currentId, r.machine, r.workorder);
  await pushNotify('üü¢ Parts In Shop ‚Äî ' + (r.machine||'Machine'), 'WO# ' + (r.workorder||'‚Äî') + ' ‚Äî Parts have arrived. Ready to go!');
  showToast('Parts marked in shop ‚Äî techs notified!');
  closeModal();
}

// ==================== HELPERS ====================
function infoBlock(r) {
  return '<div class="info-block">' +
    '<div class="info-row"><span class="info-key">Tech</span><span class="info-val">' + esc(r.tech||'‚Äî') + '</span></div>' +
    '<div class="info-row"><span class="info-key">Make / Model</span><span class="info-val">' + esc([r.make,r.model].filter(Boolean).join(' ')||'‚Äî') + '</span></div>' +
    '<div class="info-row"><span class="info-key">Serial</span><span class="info-val">' + esc(r.serial||'‚Äî') + '</span></div>' +
    '<div class="info-row"><span class="info-key">Work Order #</span><span class="info-val">' + esc(r.workorder||'‚Äî') + '</span></div>' +
    (r.notes ? '<div class="info-row"><span class="info-key">Notes</span><span class="info-val">' + esc(r.notes) + '</span></div>' : '') +
    '<div class="info-row"><span class="info-key">Updated</span><span class="info-val" style="font-size:12px;color:var(--muted);">' + ago(r.updatedAt) + '</span></div>' +
    '</div>';
}

function partsRO(parts) {
  if (!parts?.length) return '<div style="color:var(--muted);font-size:14px;margin-bottom:10px;">No parts listed.</div>';
  return '<div class="section-label">Parts Requested</div><table class="parts-table"><thead><tr><th>Description</th><th>Qty</th><th>Part #</th></tr></thead><tbody>' +
    parts.map(p => '<tr><td>' + esc(p.desc||'‚Äî') + '</td><td>' + (p.qty||1) + '</td><td>' + esc(p.partnum||'‚Äî') + '</td></tr>').join('') + '</tbody></table>';
}

function itemsRO(items, dec) {
  if (!items?.length) return '<div style="color:var(--muted);font-size:14px;">No parts details yet.</div>';
  return '<table class="parts-table"><thead><tr><th>Description</th><th>Qty</th><th>Part #</th><th>Price</th><th>Vendor</th><th>Lead Time</th><th>Decision</th></tr></thead><tbody>' +
    items.map((p,i) => {
      const d = dec ? dec[i] : null;
      const cls = d === 'decline' ? ' class="td-declined"' : '';
      const decCell = d ? (d==='approve' ? '<span class="dec-tag dec-tag-approve">‚úÖ Approved</span>' : '<span class="dec-tag dec-tag-decline">‚úï Declined</span>') : '‚Äî';
      return '<tr><td' + cls + '>' + esc(p.desc||'‚Äî') + '</td><td>' + (p.qty||1) + '</td><td>' + esc(p.partnum||'‚Äî') + '</td><td>' + esc(p.price||'‚Äî') + '</td><td>' + esc(p.vendor||'‚Äî') + '</td><td>' + esc(p.leadtime||'‚Äî') + '</td><td>' + decCell + '</td></tr>';
    }).join('') + '</tbody></table>';
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function ago(ts) {
  if (!ts) return '‚Äî';
  const m = Math.floor((Date.now()-ts)/60000);
  if (m < 1) return 'Just now';
  if (m < 60) return m + 'm ago';
  const h = Math.floor(m/60);
  if (h < 24) return h + 'h ago';
  return Math.floor(h/24) + 'd ago';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ==================== BOOT ====================
// Auto-refresh every 30 seconds so all devices stay in sync
setInterval(() => { renderMain(); renderBanners(); }, 30000);
renderBanners();
renderMain();

// Expose functions to window for onclick handlers
window.switchRole = switchRole;
window.openNewForm = openNewForm;
window.openRequest = openRequest;
window.closeModal = closeModal;
window.setupNotifications = setupNotifications;
window.saveDraft = saveDraft;
window.submitMgr = submitMgr;
window.mgrDecide = mgrDecide;
window.mgrDone = mgrDone;
window.submitDecisions = submitDecisions;
window.setDec = setDec;
window.partsAction = partsAction;
window.markInShop = markInShop;
window.addPart = addPart;
window.removePart = removePart;
window.handlePhotos = handlePhotos;
window.addItem = addItem;
window.removeItem = removeItem;
window.syncItems = syncItems;
window.dismissBanner = dismissBanner;
})();
</script>
</body>
</html>
